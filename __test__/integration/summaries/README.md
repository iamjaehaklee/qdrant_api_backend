# OCR Summaries Collection - Integration Test Suite

Ï¢ÖÌï© ÌÖåÏä§Ìä∏ suite for `ocr_summaries` Qdrant collection CRUD and Search operations.

## üìÅ Test Structure

```
__test__/integration/summaries/
‚îú‚îÄ‚îÄ conftest.py                          # Pytest fixtures and utilities
‚îú‚îÄ‚îÄ README.md                            # This file
‚îú‚îÄ‚îÄ crud/
‚îÇ   ‚îú‚îÄ‚îÄ test_create_summaries.py        # POST /summaries
‚îÇ   ‚îú‚îÄ‚îÄ test_read_summaries.py          # GET /summaries/{id}
‚îÇ   ‚îú‚îÄ‚îÄ test_update_summaries.py        # PUT /summaries/{id}
‚îÇ   ‚îî‚îÄ‚îÄ test_delete_summaries.py        # DELETE /summaries/{id}
‚îî‚îÄ‚îÄ search/
    ‚îú‚îÄ‚îÄ test_dense_search.py            # POST /summaries/search/dense
    ‚îú‚îÄ‚îÄ test_sparse_search.py           # POST /summaries/search/sparse
    ‚îú‚îÄ‚îÄ test_matchtext_search.py        # POST /summaries/search/matchtext
    ‚îú‚îÄ‚îÄ test_hybrid_rrf_search.py       # POST /summaries/search/dense_sparse_rrf
    ‚îú‚îÄ‚îÄ test_recommend_search.py        # POST /summaries/search/recommend
    ‚îú‚îÄ‚îÄ test_discover_search.py         # POST /summaries/search/discover
    ‚îú‚îÄ‚îÄ test_scroll_search.py           # POST /summaries/search/scroll
    ‚îî‚îÄ‚îÄ test_filter_search.py           # POST /summaries/search/filter
```

## üéØ Test Coverage

### CRUD Operations (4 endpoints)

#### 1. `test_create_summaries.py`
- ‚úÖ Single summary creation with basic fields
- ‚úÖ UUID auto-generation vs manual specification
- ‚úÖ Optional file_id handling
- ‚úÖ Batch creation (10 summaries)
- ‚úÖ Real sample data creation
- ‚úÖ Long text handling (>1000 characters)
- ‚úÖ Korean legal terminology
- ‚ùå Error cases: missing fields, invalid types, empty text

**Test Count**: 15 tests

#### 2. `test_read_summaries.py`
- ‚úÖ Single summary retrieval
- ‚úÖ All payload fields verification
- ‚úÖ Multiple summaries sequential read
- ‚úÖ Long text preservation
- ‚úÖ Korean text encoding preservation
- ‚úÖ Optional field handling (file_id=None)
- ‚úÖ Timestamp format validation
- ‚ùå Error cases: non-existent ID, invalid UUID, deleted summary

**Test Count**: 13 tests

#### 3. `test_update_summaries.py`
- ‚úÖ Metadata-only updates (no embedding regeneration)
- ‚úÖ Summary_text updates (automatic embedding regeneration)
- ‚úÖ Combined metadata + text updates
- ‚úÖ Partial field updates
- ‚úÖ Long text updates
- ‚úÖ Korean legal terminology updates
- ‚úÖ Multiple sequential updates
- ‚ùå Error cases: non-existent summary, invalid types, empty payload

**Test Count**: 13 tests

#### 4. `test_delete_summaries.py`
- ‚úÖ Single summary deletion
- ‚úÖ Delete ‚Üí Read returns 404
- ‚úÖ Batch deletion (5 summaries)
- ‚úÖ Idempotent deletion (delete twice)
- ‚úÖ Delete ‚Üí Search not found
- ‚úÖ Long text summary deletion
- ‚úÖ Special character handling
- ‚ùå Error cases: non-existent ID, invalid UUID

**Test Count**: 11 tests

### Search Operations (8 endpoints)

#### 5. `test_dense_search.py` - Semantic Similarity Search
- ‚úÖ Basic semantic search with Korean queries
- ‚úÖ Score threshold filtering
- ‚úÖ Limit control (5, 10, 20 results)
- ‚úÖ Project_id filtering
- ‚úÖ File_id filtering
- ‚úÖ Combined filters (project + file)
- ‚úÖ Semantic similarity verification (different words, similar meaning)
- ‚úÖ Real sample data search
- ‚úÖ Empty results handling
- ‚ùå Error cases: missing query_text, invalid limit, invalid threshold

**Test Count**: 12 tests

#### 6. `test_sparse_search.py` - Keyword-Based Search
- ‚úÖ Basic keyword search with Korean
- ‚úÖ Korean morphological analysis (Kiwi)
- ‚úÖ Project_id and file_id filters
- ‚úÖ Score threshold filtering
- ‚ùå Error case: missing query_text

**Test Count**: 5 tests

#### 7. `test_matchtext_search.py` - Full-Text Matching
- ‚úÖ Basic full-text matching
- ‚úÖ Exact phrase matching
- ‚úÖ Project_id and file_id filters
- ‚úÖ No results handling
- ‚ùå Error case: missing query_text

**Test Count**: 5 tests

#### 8. `test_hybrid_rrf_search.py` - Hybrid Dense+Sparse RRF
- ‚úÖ Basic hybrid search combining semantic + keyword
- ‚úÖ RRF k parameter variation (30, 60, 100)
- ‚úÖ Project_id and file_id filters
- ‚úÖ Score threshold filtering
- ‚ùå Error cases: missing query_text, invalid k value

**Test Count**: 6 tests

#### 9. `test_recommend_search.py` - Recommendation System
- ‚úÖ Positive examples only
- ‚úÖ Positive + negative examples
- ‚úÖ Strategy: average_vector
- ‚úÖ Strategy: best_score
- ‚úÖ Project_id filtering
- ‚ùå Error case: missing positive_ids

**Test Count**: 6 tests

#### 10. `test_discover_search.py` - Context-Based Discovery
- ‚úÖ Basic discovery with context pairs
- ‚úÖ Multiple context pairs (3 pairs)
- ‚úÖ Project_id filtering
- ‚ùå Error cases: missing target_text, missing context_pairs

**Test Count**: 5 tests

#### 11. `test_scroll_search.py` - Paginated Large Result Sets
- ‚úÖ Basic scroll without filters
- ‚úÖ Custom limit control
- ‚úÖ Project_id filtering
- ‚úÖ File_id filtering
- ‚úÖ Pagination with offset
- ‚ùå Error case: invalid limit (>1000)

**Test Count**: 6 tests

#### 12. `test_filter_search.py` - Metadata-Only Filtering
- ‚úÖ Filter by project_id only
- ‚úÖ Filter by file_id only
- ‚úÖ Combined project_id + file_id filters
- ‚úÖ Limit parameter
- ‚úÖ Offset parameter for pagination
- ‚úÖ No matching results
- ‚úÖ Empty filters (returns all)

**Test Count**: 8 tests

## üìä Total Test Statistics

- **Total Test Files**: 12
- **Total Test Cases**: ~100+ tests
- **Endpoints Covered**: 12/12 (100%)
- **Test Data**: 51 real legal document summaries from `Î∂ÄÎèôÏÇ∞ÏÜåÏú†Í∂åÎì±Í∏∞ÏÜåÏÜ°`

## üõ†Ô∏è Test Data

### Sample Data Location
```
__test__/sample_generated/Î∂ÄÎèôÏÇ∞ÏÜåÏú†Í∂åÎì±Í∏∞ÏÜåÏÜ°/ocr_summaries/
```

### Sample Data Structure
```json
{
  "summary_id": "de21465d-c1d5-4fd2-a0d4-4e2159136c41",
  "project_id": 1001,
  "file_id": 21,
  "summary_text": "ÏõêÍ≥† ÍπÄÏ≤†ÏàòÏù¥ ÌîºÍ≥† Ïù¥ÏòÅÌù¨ÏóêÍ≤å Î∞úÏÜ°Ìïú ÎÇ¥Ïö©Ï¶ùÎ™Ö...",
  "created_at": "2024-08-22T06:00:00+00:00"
}
```

### Data Files (51 files)
- Í∞ë1Ìò∏Ï¶ù ~ Í∞ë21Ìò∏Ï¶ù (ÏõêÍ≥† Ï¶ùÍ±∞)
- ÏùÑ1Ìò∏Ï¶ù ~ ÏùÑ8Ìò∏Ï¶ù (ÌîºÍ≥† Ï¶ùÍ±∞)
- ÏÜåÏû•, ÎãµÎ≥ÄÏÑú, Ï§ÄÎπÑÏÑúÎ©¥
- Î≥ÄÎ°†ÎÖπÏ∑®Î°ù, Ï¶ùÏù∏Ïã†Î¨∏Ï°∞ÏÑú
- Í∞êÏ†ïÏÑú, Í≥ÑÏïΩÏÑú, ÏòÅÏàòÏ¶ù, Îì±Í∏∞Î∂ÄÎì±Î≥∏ Îì±

## üöÄ Running Tests

### Prerequisites
```bash
# 1. Activate virtual environment
source venv/bin/activate

# 2. Install test dependencies
pip install pytest pytest-asyncio httpx

# 3. Start FastAPI server (REQUIRED)
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### Run All Tests
```bash
# All summaries tests
pytest __test__/integration/summaries/ -v

# CRUD tests only
pytest __test__/integration/summaries/crud/ -v

# Search tests only
pytest __test__/integration/summaries/search/ -v
```

### Run Specific Test Files
```bash
# Create tests
pytest __test__/integration/summaries/crud/test_create_summaries.py -v

# Dense search tests
pytest __test__/integration/summaries/search/test_dense_search.py -v

# Hybrid RRF tests
pytest __test__/integration/summaries/search/test_hybrid_rrf_search.py -v
```

### Run Specific Test Cases
```bash
# Single test method
pytest __test__/integration/summaries/crud/test_create_summaries.py::TestCreateSummaries::test_create_single_summary_basic -v

# All tests in a class
pytest __test__/integration/summaries/search/test_dense_search.py::TestDenseSearch -v
```

## üîß Test Utilities (conftest.py)

### Fixtures
- `client`: AsyncClient for HTTP requests
- `sample_summaries`: 5 sample summaries
- `single_sample_summary`: 1 sample summary
- `all_sample_summaries`: All 51 sample summaries
- `cleanup_test_summaries`: Auto-cleanup created summaries

### Helper Functions
- `load_sample_summaries(limit)`: Load sample data from JSON files
- `load_single_summary(filename)`: Load specific file
- `create_test_summary(...)`: Generate test summary payload
- `cleanup_summary(client, id)`: Delete single summary
- `cleanup_summaries(client, ids)`: Delete multiple summaries
- `assert_summary_response(data, expected)`: Validate response structure
- `assert_search_response(data, min, max)`: Validate search results
- `assert_scores_descending(results)`: Verify score ordering

## üìù Test Scenarios

### Workflow Tests
Each test file includes integration scenarios:

1. **Create ‚Üí Read ‚Üí Update ‚Üí Delete** (CRUD workflow)
2. **Create ‚Üí Search ‚Üí Verify** (Search workflow)
3. **Update Text ‚Üí Search ‚Üí Find New Content** (Embedding regeneration)
4. **Delete ‚Üí Search ‚Üí Not Found** (Deletion verification)
5. **Batch Operations** (Multiple summaries handling)

### Edge Cases
- Empty strings
- Very long texts (>1000 characters)
- Korean special characters
- Invalid UUIDs
- Non-existent IDs
- Invalid data types
- Missing required fields
- Out-of-range parameters

### Performance Tests
- Batch creation (10+ summaries)
- Large result sets (scroll search)
- Pagination efficiency
- Multiple sequential operations

## ‚úÖ Validation Checks

Each test validates:
1. **HTTP Status Codes**: 200, 201, 204, 404, 422, 500
2. **Response Schema**: Pydantic model compliance
3. **Data Accuracy**: Input values match output
4. **Embedding Generation**: Vector search returns results
5. **Filter Accuracy**: Filtered results meet criteria
6. **Score Ordering**: Search results sorted by relevance
7. **Pagination**: Offset and limit work correctly

## üîç Test Methodology

### Test Structure
```python
async def test_scenario_name(self, client: AsyncClient):
    """Test: Description
    Expected: Expected outcome
    """
    # 1. Setup: Create test data
    created_ids = []
    payload = create_test_summary(...)
    response = await client.post("/summaries", json=payload)
    created_ids.append(response.json()["point_id"])

    # 2. Execute: Perform operation
    search_payload = {...}
    response = await client.post("/summaries/search/dense", json=search_payload)

    # 3. Assert: Verify results
    assert response.status_code == 200
    assert_search_response(response.json())

    # 4. Cleanup: Remove test data
    await cleanup_summaries(client, created_ids)
```

## üö® Important Notes

### Server Requirement
**CRITICAL**: FastAPI server MUST be running before executing tests.
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### Test Isolation
- Each test creates its own data
- Cleanup after each test (no pollution)
- Uses unique project_ids/file_ids to avoid conflicts

### Embedding Generation
- Dense embeddings: Gemini `embedding-001` (1536 dimensions)
- Sparse embeddings: Kiwi (Korean) or FastEmbed BM25
- Automatic generation on create/update

### Real Data Usage
Tests use actual legal document summaries from `Î∂ÄÎèôÏÇ∞ÏÜåÏú†Í∂åÎì±Í∏∞ÏÜåÏÜ°` case files for realistic validation.

## üìö Related Documentation

- FastAPI Server: `/app/main.py`
- Summaries Router: `/app/routers/summaries.py`
- Search Router: `/app/routers/search_summaries.py`
- Data Models: `/app/models.py`, `/app/models_search.py`
- Project README: `/CLAUDE.md`

## üêõ Troubleshooting

### Tests Fail with Connection Error
‚Üí Ensure FastAPI server is running on `localhost:8000`

### Tests Fail with 404 on Search
‚Üí Verify Qdrant collection `ocr_summaries` exists

### Embedding Errors
‚Üí Check `GEMINI_API_KEY` in `.env` file

### Cleanup Not Working
‚Üí Check Qdrant connection and API key permissions
